<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="kindrat" id="1">
        <sql splitStatements="true">
            DROP SEQUENCE IF EXISTS player.profile_id_seq CASCADE;
            DROP INDEX IF EXISTS player.profile_login_idx;
            DROP INDEX IF EXISTS player.profile_login_password_idx;
            DROP TABLE IF EXISTS player.profile;
            DROP TABLE IF EXISTS player.units;
            DROP SCHEMA IF EXISTS player;
            DROP TABLE IF EXISTS static.rooms;
            DROP SCHEMA IF EXISTS static;
            DROP TYPE IF EXISTS role;

            CREATE TYPE role AS ENUM ('USER', 'ADMIN', 'NONE');

            CREATE SCHEMA player AUTHORIZATION postgres;

            GRANT ALL ON SCHEMA player TO postgres;
            COMMENT ON SCHEMA player IS 'Player related tables';

            CREATE TABLE player.role (
                id          INTEGER,
                userRole    role,
                PRIMARY KEY (id)
            )WITH (
                OIDS=FALSE
            );

            CREATE TABLE player.profile (
                id BIGSERIAL NOT NULL,
                first_name TEXT,
                last_name TEXT,
                nickname TEXT,
                login TEXT NOT NULL,
                password TEXT NOT NULL,
                role INTEGER NOT NULL,
                CONSTRAINT profile_pkey PRIMARY KEY (id),
                CONSTRAINT profile_login_key UNIQUE (login),
                FOREIGN KEY (role) REFERENCES player.role (id) ON DELETE CASCADE ON UPDATE CASCADE
            )WITH (
                OIDS=FALSE
            );
            ALTER TABLE player.profile OWNER TO postgres;

            CREATE INDEX profile_login_idx
                ON player.profile
                USING hash
                (login COLLATE pg_catalog."default");

            CREATE INDEX profile_login_password_idx
                ON player.profile
                USING btree
                (login COLLATE pg_catalog."default", password COLLATE pg_catalog."default");

            CREATE TABLE player.units (
                player_id BIGINT NOT NULL
            )WITH (
                OIDS=FALSE
            );

            CREATE SCHEMA static AUTHORIZATION postgres;

            GRANT ALL ON SCHEMA static TO postgres;
            COMMENT ON SCHEMA static IS 'Static data';

            CREATE TABLE static.rooms (
                id BIGSERIAL NOT NULL,
                CONSTRAINT room_pkey PRIMARY KEY (id)
            )WITH (
                OIDS=FALSE
            );
        </sql>
        <rollback>
            <sql>
                DROP SEQUENCE player.profile_id_seq;
                DROP INDEX player.profile_login_idx;
                DROP INDEX player.profile_login_password_idx;
                DROP TABLE player.profile;
                DROP TABLE IF EXISTS player.units;
                DROP SCHEMA IF EXISTS player;
                DROP TABLE IF EXISTS static.rooms;
                DROP SCHEMA IF EXISTS static;
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>
